updateStrategy:
  # -- Customize updateStrategy: RollingUpdate or OnDelete
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 0
    maxSurge: 1

providers:
  kubernetesIngress:
    enabled: true
    allowExternalNameServices: true
    allowEmptyServices: false
    publishedService:
      enabled: true

service:
  enabled: true
  type: LoadBalancer
  # -- Additional annotations applied to both TCP and UDP services (e.g. for cloud provider specific config)
  annotations: 
    metallb.universe.tf/ip-allocated-from-pool: single-lb-pool
  spec:
    loadBalancerIP: "192.168.88.7"

securityContext:
  capabilities:
    drop: [ALL]
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false

env:
  - name: TRAEFIK_ENTRYPOINTS_WEB_ADDRESS
    value: :80
  - name: TRAEFIK_ENTRYPOINTS_WEBSECURE_ADDRESS
    value: :443
  - name: TRAEFIK_ENTRYPOINTS_WEB_HTTP_REDIRECTIONS_ENTRYPOINT_TO
    value: websecure
  - name: TRAEFIK_ENTRYPOINTS_WEB_HTTP_REDIRECTIONS_ENTRYPOINT_SCHEME
    value: https
  - name: TRAEFIK_ENTRYPOINTS_WEB_HTTP_MIDDLEWARES
    value: traefik-bouncer
  - name: TRAEFIK_ENTRYPOINTS_WEBSECURE_HTTP_MIDDLEWARES
    value: traefik-bouncer

logs:
  general:
    format: "json"
  access:
    enabled: true
    format: "json"
    fields:
      headers: 
        defaultmode: keep

ingressRoute:
  dashboard:
    enabled: true
    matchRule: Host(`tf.yiannis.io`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))
    entryPoints: ["websecure"]

volumes:
  - name: crowdsec-bouncer-tls
    mountPath: /etc/traefik/crowdsec-certs/
    type: secret

experimental:
  plugins:
    bouncer:
      moduleName: "github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
      version: "v1.3.5"
    # real-ip:
    #   moduleName: github.com/Paxxs/traefik-get-real-ip
    #   version: "v1.0.3"

additionalArguments:
  - "--experimental.plugins.bouncer.moduleName=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
  - "--experimental.plugins.bouncer.version=v1.3.5"
  # - "--experimental.plugins.real-ip.moduleName=github.com/Paxxs/traefik-get-real-ip"
  # - "--experimental.plugins.real-ip.version=v1.0.3"
  - "--entrypoints.web.http.middlewares=traefik-bouncer@kubernetescrd" # traefik-real-ip@kubernetescrd"
  - "--entrypoints.websecure.http.middlewares=traefik-bouncer@kubernetescrd" # traefik-real-ip@kubernetescrd"
  - "--entrypoints.web.forwardedHeaders.trustedIPs=10.244.0.50/32,10.244.2.101/32"
  - "--entrypoints.websecure.forwardedHeaders.trustedIPs=10.244.0.50/32,10.244.2.101/32"
  - "--providers.kubernetescrd"

# http:
#   middlewares:
#     real-ip-cf:
#       plugin:
#         real-ip:
#           Proxy:
#             - proxyHeadername: X-From-Cdn
#               proxyHeadervalue: cf-foo
#               realIP: Cf-Connecting-Ip
#               OverwriteXFF: true # default: false, v1.0.2 or above
#             - proxyHeadername: "*"
#               realIP: RemoteAddr

entryPoints:
  web:
    forwardedHeaders:
      trustedIPs:
        - 10.244.0.50/32
        - 10.244.2.101/32
  websecure:
    forwardedHeaders:
      trustedIPs:
        - 10.244.0.50/32
        - 10.244.2.101/32


# entryPoints:
#   web:
#     forwardedHeaders:
#       trustedIPs:
#         - 10.244.0.50/32
#         - 10.244.2.101/32
        # Start of Cloudlare's public IP list
        # - 173.245.48.0/20
        # - 103.21.244.0/22
        # - 103.22.200.0/22
        # - 103.31.4.0/22
        # - 141.101.64.0/18
        # - 108.162.192.0/18
        # - 190.93.240.0/20
        # - 188.114.96.0/20
        # - 197.234.240.0/22
        # - 198.41.128.0/17
        # - 162.158.0.0/15
        # - 104.16.0.0/13
        # - 104.24.0.0/14
        # - 172.64.0.0/13
        # - 131.0.72.0/22
        # - 2400:cb00::/32
        # - 2606:4700::/32
        # - 2803:f800::/32
        # - 2405:b500::/32
        # - 2405:8100::/32
        # - 2a06:98c0::/29
        # - 2c0f:f248::/32
        # End of Cloudlare's public IP list
  # HTTPS endpoint, with domain wildcard
  # websecure:
  #   forwardedHeaders:
  #     # Reuse the list of Cloudflare's public IPs from above
  #     trustedIPs:
  #       - 10.244.0.50/32
  #       - 10.244.2.101/32