apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: promtail
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - namespace: argocd
      - namespace: jellyfin
  template:
    metadata:
      name: 'promtail-{{namespace}}'
      namespace: argocd
      labels:
        app: 'promtail-{{namespace}}'
    spec:
      destination:
        namespace: '{{namespace}}'
        server: https://kubernetes.default.svc
      project: default
      sources:
      - chart: promtail
        repoURL: https://grafana.github.io/helm-charts
        targetRevision: 6.15.5
        helm:
          releaseName: 'promtail-{{namespace}}'
          # valueFiles:
          #   - $values/applicationsets/promtail/values/values.yaml
          # parameters:
          #   - name: 'config.snippets.scrapeConfigs[0].kubernetes_sd_configs[0].namespaces.names'
          #     value: '{{namespace}}'
          values: |
            tolerations: {}
            daemonset:
              enabled: false
            deployment:
              enabled: true
            config:
              lokiAddress: http://loki.mnitoring.svc.cluster.local:3100/loki/api/v1/push
              snippets:
                pipelineStages:
                  - cri: {}
                scrapeConfigs: |
                  kubernetes_sd_configs:
                  - role: pod
                relabel_configs:
                  - source_labels:
                      - __meta_kubernetes_pod_controller_name
                    regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
                    action: replace
                    target_label: __tmp_controller_name
                  - source_labels:
                      - __meta_kubernetes_pod_label_app_kubernetes_io_name
                      - __meta_kubernetes_pod_label_app
                      - __tmp_controller_name
                      - __meta_kubernetes_pod_name
                    regex: ^;*([^;]+)(;.*)?$
                    action: replace
                    target_label: app
                  - source_labels:
                      - __meta_kubernetes_pod_label_app_kubernetes_io_instance
                      - __meta_kubernetes_pod_label_release
                    regex: ^;*([^;]+)(;.*)?$
                    action: replace
                    target_label: instance
                  - source_labels:
                      - __meta_kubernetes_pod_label_app_kubernetes_io_component
                      - __meta_kubernetes_pod_label_component
                    regex: ^;*([^;]+)(;.*)?$
                    action: replace
                    target_label: component
                  - action: replace
                    source_labels:
                      - __meta_kubernetes_pod_node_name
                    target_label: node_name
                  - action: replace
                    source_labels:
                      - __meta_kubernetes_namespace
                    target_label: namespace
                  - action: replace
                    replacement: $1
                    separator: /
                    source_labels:
                      - namespace
                      - app
                    target_label: job
                  - action: replace
                    source_labels:
                      - __meta_kubernetes_pod_name
                    target_label: pod
                  - action: replace
                    source_labels:
                      - __meta_kubernetes_pod_container_name
                    target_label: container
                  - action: replace
                    replacement: /var/log/pods/*$1/*.log
                    separator: /
                    source_labels:
                      - __meta_kubernetes_pod_uid
                      - __meta_kubernetes_pod_container_name
                    target_label: __path__
                  - action: replace
                    regex: true/(.*)
                    replacement: /var/log/pods/*$1/*.log
                    separator: /
                    source_labels:
                      - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash
                      - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash
                      - __meta_kubernetes_pod_container_name
                    target_label: __path__
      # - repoURL: https://github.com/ipanagiotidis/homelab-gitops.git
      #   targetRevision: dev
      #   ref: values
      # Sync policy
      syncPolicy:
        automated: # automated sync by default retries failed attempts 5 times with following delays between attempts ( 5s, 10s, 20s, 40s, 80s ); retry controlled using `retry` field.
          prune: true # Specifies if resources should be pruned during auto-syncing ( false by default ).
          selfHeal: true # Specifies if partial app sync should be executed when resources are changed only in target Kubernetes cluster and no git change detected ( false by default ).
        syncOptions:     # Sync options which modifies sync behavior
        - Validate=true # disables resource validation (equivalent to 'kubectl apply --validate=true')
        - CreateNamespace=true # Namespace Auto-Creation ensures that namespace specified as the application destination exists in the destination cluster.
        # The retry feature is available since v1.7
