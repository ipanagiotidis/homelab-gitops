apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: promtail
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - namespace: argocd
      - namespace: jellyfin
  template:
    metadata:
      name: 'promtail-{{namespace}}'
      namespace: argocd
      labels:
        app: 'promtail-{{namespace}}'
    spec:
      destination:
        namespace: '{{namespace}}'
        server: https://kubernetes.default.svc
      project: default
      sources:
      - chart: promtail
        repoURL: https://grafana.github.io/helm-charts
        targetRevision: 6.15.5
        helm:
          releaseName: 'promtail-{{namespace}}'
          valueFiles:
            - $values/applicationsets/promtail/values/values.yaml
          parameters:
          - name: "config.snippets.scrapeConfigs[0].kubernetes_sd_configs[0].namespaces.names"
            value: '{{namespace}}'
      - repoURL: https://github.com/ipanagiotidis/homelab-gitops.git
        targetRevision: dev
        ref: values
      # Sync policy
      syncPolicy:
        automated: # automated sync by default retries failed attempts 5 times with following delays between attempts ( 5s, 10s, 20s, 40s, 80s ); retry controlled using `retry` field.
          prune: true # Specifies if resources should be pruned during auto-syncing ( false by default ).
          selfHeal: true # Specifies if partial app sync should be executed when resources are changed only in target Kubernetes cluster and no git change detected ( false by default ).
        syncOptions:     # Sync options which modifies sync behavior
        - Validate=true # disables resource validation (equivalent to 'kubectl apply --validate=true')
        - CreateNamespace=true # Namespace Auto-Creation ensures that namespace specified as the application destination exists in the destination cluster.
        # The retry feature is available since v1.7
